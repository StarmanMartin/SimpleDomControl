.. _sdc-controller-label:

SDC controller
==============

A controller has two parts a client and a server. This is preceded by a short chapter on generating a controller.
This is followed by a paragraph on how the
server code is to be understood. This is followed by a short
overview of the client code (HTML, SCSS, JavaScript)

.. _new-controller-controller:

New controller
--------------

We recommend delegating the creation of controllers to the provided scripts designed for this purpose.
To initiate the creation of a new controller, execute the following command within the project directory:

.. code-block:: sh

    $ python manage.py sdc_cc

To complete the process, respond to two prompts in the terminal. First, specify the Django app
in which the controller should be created (e.g., *mypage*). Second, provide a name for the new controller
(for example, *about_me*). It's important to note that only snake case should be used for the controller name.
For additional details, refer to :ref:`sdc-cc-core`.

Alternatively, you can skip the prompts using the following command:


.. code-block:: sh

    $ python manage.py sdc_cc -a <django_app_name> -c <sdc_controller_name>

However, the *sdc_controller_name* must be specified in **snake_case**. If the Django app is not specified in the settings, the provided parameter will be ignored.



Server part
-----------

A controller on the client side usually consists of three files: an HTML template file, an SCSS style file, and a JavaScript code file.
The JavaScript code contains the controller class with a *contentUrl* property, pointing to an entry point registered in the *sdc_url.py*
file. This file is automatically generated when the first controller in the corresponding Django app is created. The registered URL then
calls a Python ViewClass, which extends *sdc_core.sdc_extensions.views.SDCView*—closely related to the *django.views.View* class. In
addition to the standard handlers like get, post, put, etc., it also has the *get_content* handler, which is called only to render and serve the controller's template.

For example, assuming we have a Django project called *mysite* with an app called *myapp*:


.. code-block:: python

    ...
    urlpatterns = [
        # scd view below
        ...
        path('main_view', sdc_views.MainView.as_view(), name='scd_view_main_view'),
        ...
    ]
    ...

*./mysite/myapp/sdc_urls.py*

.. code-block:: python

    ...
    class MainView(SDCView):
        template_name='main_test/sdc/main_view.html'

        def get_content(self, request, *args, **kwargs):
            """
            Handle the content retrieval for the controller.

            Parameters:
                - request (HttpRequest): The request object.
                - args (list): Additional positional arguments.
                - kwargs (dict): Additional keyword arguments.

            Returns:
                HttpResponse: The HTML content to be rendered.

            Raises:
                Exception: Raise an exception if an error occurs during content retrieval.
            """
            try:
                # Your Django-specific logic and interactions can be added here within the get_content method.
                return render(request, self.template_name)
            except Exception as e:
                # Handle exceptions gracefully, raising an exception for unexpected errors.
                raise Exception(f"Error retrieving content: {e}")
    ...

*./mysite/myapp/sdc_views.py*

.. code-block:: js

    ...
    class MainViewController extends AbstractSDC {

        constructor() {
            super();
            this.contentUrl = "/sdc_view/main_test/main_view"; //<main-view></main-view>

    ...

*./Assets/src/myapp/controller/main_view/main_view.js*

In the *get_content* method, you have access to the full potential of Django.
However, you must respond with HTML content or otherwise throw an exception.

Other special features compared to handling with Djnago are premissions and redirection, both of which are described in the following section: "Error handling and Permissions".
Yet we need to introduce on farther case here in this section: *How to parameterize a query*.

In order to use the development in a meaningful way, it must be possible to parameterize queries. Since it is often necessary to parameterize a query, SDC adds another Django command. This can be achieved by adding URL parameters to sdc_urls.py:



.. code-block:: python

    ...
    urlpatterns = [
        # scd view below
        ...
        path('main_view/<int:pk>', sdc_views.MainView.as_view(), name='scd_view_main_view'),
        ...
    ]
    ...

*./mysite/myapp/sdc_urls.py*

After running:

.. code-block:: sh

    $ python manage.py sdc_update_urls

The client will automatically update its contentUrl:

.. code-block:: js

    ...
    class MainViewController extends AbstractSDC {

        constructor() {
            super();
            this.contentUrl = "/sdc_view/main_test/main_view/%(pk)s"; //<main-view data-pk=""></main-view>

Redirect, Error handling and Permissions
________________________________________

Auch an Redirect, Errors zu Premissions ist gedacht. Eine mitgeliefete methode erlaubt einen Redirect des Clients. Auch Errors können einfach über Error *raise*ing gemacht werden.
Die Premisstions sind über Abstrackte Klassen  der Views gehandhabt. .

Redirect
++++++++

A redirect can be simplly triggered from the server side by returning *sdc_core.sdc_extensions.response.send_redirect*.


.. automodule:: sdc_core.sdc_extentions.response
   :members: send_redirect

.. code-block:: python

    from sdc_core.sdc_extensions.response import send_redirect
    ...
    class MainView(SDCView):
        template_name='main_test/sdc/main_view.html'

        def get_content(self, request, *args, **kwargs):
            """
            Handle the content retrieval for the controller.

            Parameters:
                - request (HttpRequest): The request object.
                - args (list): Additional positional arguments.
                - kwargs (dict): Additional keyword arguments.

            Returns:
                HttpResponse: Redirect to the controller: 'second-view'

            Raises:
                Exception: Raise an exception if an error occurs during content retrieval.
            """
            return send_redirect('second-view')
    ...

*./mysite/myapp/sdc_views.py*

.. code-block:: js

    ...
    class MainViewController extends AbstractSDC {

        constructor() {
            super();
            this.contentUrl = "/sdc_view/main_test/main_view"; //<main-view></main-view>

    ...

*./Assets/src/myapp/controller/main_view/main_view.js*